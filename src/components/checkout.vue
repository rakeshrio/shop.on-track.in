<template>
  <div class="col-md-12 col-12 " style="overflow:hidden">
      
    <div class="col-md-9 col-12 p-0" style="margin:0 auto">
        
        <p class="text-center pb-1"  style="color:red" v-if="message">{{message}}</p>
        <div class="col-md-12 m-auto p-0 col-12">
            <h1 class="font2 mb-4 mt-5 text-left" style="">Billing Details</h1>
            <form class="text-left">
        <div class="form-row text-left">
            <div class="form-group col-md-6 col-6">
            <label for="inputEmail4">First Name</label>
            <input type="text" v-model="first_name" class="form-control" id="inputEmail4" placeholder="">
            </div>
            <div class="form-group col-md-6 col-6">
            <label for="inputPassword4">Last Name</label>
            <input type="text" v-model="last_name" class="form-control" id="inputPassword4" placeholder="">
            </div>
        </div>
  
    
        <div class="form-group  ">
            <label for="inputZip">Phone Number</label>
            <input type="number" v-model="phone_number" class="form-control" id="inputZip">
        </div>
        <div class="form-group  ">
            <label for="inputZip">Email Address</label>
            <input type="email" v-model="email"  class="form-control" id="inputZip">
        </div>
        <h1 class="font2 mb-4 mt-5 text-left" style="">Delivery Details</h1>
        <div class="form-group  ">
            <label for="inputZip">Street Address</label>
            <input type="text" v-model="street_address"  class="form-control" id="inputZip">
        </div>
        <div class="form-group  ">
            <label for="inputZip">City/Town</label>
            <input type="text" v-model="city"  class="form-control" id="inputZip">
        </div>
        <div class="row col-md-12 m-0 p-0">
            <div class="form-group  col-md-6 m-0 p-0 ">
                <label for="inputZip">State</label>
                <input type="text" v-model="state"  class="form-control" id="inputZip">
            </div>
            <div class="form-group  col-md-6 cvb m-0 pr-0">
                <label for="inputZip">Pincode</label>
                <input type="number" v-model="post_code"  class="form-control" id="inputZip">
            </div>
        <h1 class="font2 mb-4 mt-5 text-left" style="">RTO Registration Details</h1>
       <div class="col-md-12 m-0 p-0 my-2">
            <label for="" >
            <input type="checkbox" v-model="rtoSameAsDelivery">
            RTO Address Same As Delivery Address
        </label>
       </div>
        <div class="form-group col-md-12 mb-3 m-0 p-0  ">
            <label for="inputZip">Street Address</label>
            <input type="text" v-model="rto_street_address"  class="form-control" id="inputZip">
        </div>
        <div class="form-group col-md-12 m-0 p-0">
            <label for="inputZip">City/Town</label>
            <input type="text" v-model="rto_city"  class="form-control" id="inputZip">
        </div>
        <div class="row col-md-12 m-0 my-3 p-0">
            <div class="form-group  col-md-6 m-0 p-0 ">
            <label for="inputZip">State</label>
            <input type="text" v-model="rto_state"  class="form-control" id="inputZip">
        </div>
        <div class="form-group  col-md-6 cvb  m-0 p-0 pl-3 pr-0">
            <label for="inputZip"> Pincode</label>
            <input type="number" v-model="rto_post_code"  class="form-control" id="inputZip">
        </div>
        </div>
        </div>
        </form>
        </div>

        <h1 class="font2 mb-4 mt-5 text-left" style="">Your Order</h1>
        <table class="table table-bordered">
            <thead>
                <tr class="text-left">
                <th scope="col">Product</th>
                <th scope="col">Total</th>
            
                </tr>
            </thead>
            <tbody class="text-left">
                <tr v-if="superdata">
                    <th scope="row">{{cartdata[0].make_model}} {{cartdata[0].color}} {{cartdata[0].variant}} {{totalPrice | currency}}
                       + Convenience Charge  {{convenienceAmount | currency}} (3%)
                    </th>
               
        
                    <td>{{checkOutPrice | currency}}</td>
                    

                </tr>

                <!-- <tr>
                    <th scope="row">Subtotal</th>
                    <td>₹ {{cartdata.price}}</td>
                </tr> -->
<!-- 
                <tr>
                    <th scope="row">Total</th>
                    <td>₹ {{cartdata.price}}</td>
                </tr> -->

            </tbody>
        </table>
        <div class="col-md-12 col-12 m-0 mt-4 p-3 mb-5 pb-5" style="background:#EBE9EB; border-radius:5px">
            <div class="col-md-12 col-12 row mb-3">
                <div class="col-md-6 m-0 p-0 text-left">
                    <p class="m-0 p-0 font3"><span><i class="fa fa-dot-circle-o pr-3" style="color:blue" aria-hidden="true"></i></span>Credit Card/Debit Card/NetBanking </p>
                </div>
                <div class="col-md-6 ghj text-left">
                    <img src="https://cdn.razorpay.com/static/assets/logo/payment.svg" alt="Credit Card/Debit Card/NetBanking">
                </div>   
            </div>
            <div class="col-md-12 p-2 mb-3" style="background:#DFDCDE">
                <p class="text-left" style="color: #515151;font-size: .92em;">Pay securely by Credit or Debit card or Internet Banking through Razorpay.</p>
            </div>
            <hr>
            <p class="text-left bnm" >Your personal data will be used to process your order, support your experience throughout this website, and for other purposes described in our <span ><a href="https://razorpay.com/privacy/" style="color:#4E44D8;cursor:pointer !important;">Privacy Policy</a></span></p>
            <div class="col-md-12 mt-4 text-center">
                <p style="color:red" v-if="!valid">Please fill all the fields.</p>
                <button class="p-2 " :disabled="!valid" style="border:none;border-radius:5px; background:#4E44D8; color:white;font-weight:500;letter-spacing:1px" @click="placeOrder">Place Order</button>
            </div>
        </div>
    
    </div>    
  </div>
</template>

<script>
const axios = require('axios');

export default {
    data(){
        return{
            superset:'',
            superdata:[],
            first_name:'',
            last_name:'',
            phone_number:'',
            email:'',
            otr_order_id:'',
            razorpay_order_id:'',
            street_address:'',
            post_code:'',
            city:'',
            state:'',
            rto_street_address:'',
            rto_post_code:'',
            rto_city:'',
            rto_state:'',
            rtoSameAsDelivery :false,
            message:''
        }
    },
 

    methods: {

        rtoSameAsDeliveryTrigger(){
            if(this.rtoSameAsDelivery){
                this.rto_street_address = this.street_address,
                this.rto_post_code = this.post_code,
                this.rto_city = this.city,
                this.rto_state =this.state

            }else{
                this.rto_street_address = '',
                this.rto_post_code = '',
                this.rto_city = '',
                this.rto_state = ''
            }
        },
        
        goto() {
            this.$router.push('/checkout')
        },
        updatedatabase(res){
            window.console.log(res)
            
            axios.put('https://backend-bikex.herokuapp.com/api/otr_purchase/confirmOrder/'+ this.otr_order_id , {
                razorpay_order_id: this.razorpay_order_id,
                razorpay_payment_id: res.razorpay_payment_id,
                payment_status:1,
                booking_status:1,
                comment:'No comment Yet'
            }).
            then(()=> {
                this.$router.push('/success/' + this.otr_order_id)
            })
            .catch(x=>{
                window.console.log(x.response.data.msg)
                this.$bvToast.toast(`Some error Occured.`, {
                    title: 'Error',
                    autoHideDelay: 5000,
                })
            })
        },
        placeOrder(){
            axios.post('https://cors-anywhere.herokuapp.com/https://backend-bikex.herokuapp.com/api/otr_purchase/generateOrder' , {
                firstname: this.first_name,
                lastname: this.last_name,
                phone:this.phone_number,
                email:this.email,
                payment_status:0,
                booking_status:0,
                del_address:this.street_address,
                del_postalCode:this.post_code,
                del_city:this.city,
                del_state:this.state,
                rto_address:this.rto_street_address,
                rto_postalCode:this.rto_post_code,
                rto_city:this.rto_city,
                rto_state:this.rto_state,
                model_id: this.cartdata[0]._id,
                superset_data: this.cartdata[0].selectedItem,
                add_ons:this.cartdata[0].addons,
                vehicle_details: this.cartdata[0].selectedItem,
                amount: this.checkOutPrice
            }).
            then(response=> {
                window.console.log(response.data)
                this.otr_order_id = response.data._id
                this.makepayment(response.data._id)
                window.console.log('1st')
            })
            .catch(x=>{
                window.console.log(x.response)
                this.$bvToast.toast(x.response, {
                    title: 'Error',
                    autoHideDelay: 5000,
                })
            })  
            //   .catch(error => { 
            //     this.message = error;
            //     this.loading= false
            // }) 
        },
       makepayment(id){
            this.loading=true
            window.console.log('2nd')
            var options = {
                            "key": "rzp_live_kNjIpPzSMA4gHS", // rzp_live_Vi238TQEagSN3x Enter the Key ID generated from the Dashboard
                            // "key":"rzp_live_Vi238TQEagSN3x",
                            "amount": this.checkOutPrice * 100, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise or INR 500.
                            "currency": "INR",
                            "name": this.cartdata[0].make_model ,
                            "email":this.email,
                            "phone":this.phone_number,
                            "order_id":id,
                            "description": "Purchase " + this.cartdata[0].make_model,
                            "payment_capture":1,    
                            "handler": ((res)=>{
                                 this.updatedatabase(res)
                            }),
                            "notes": {
                                "address": "note value",
                                "vehicle_id":this.cartdata[0]._id,
                                "superset_id": this.cartdata[0].selectedItem.id
                            },
                            "theme": { 
                                "color": "#ffb52f"
                            }
                        };
                        this.$http.post('https://cors-anywhere.herokuapp.com/https://rzp_live_Vi238TQEagSN3x:c2ImBntiX8l4ZwHPTXfbJdx4@bikex.in/v1/orders',{
                            "amount":this.checkOutPrice * 100,
                            "currency":"INR",
                            "payment_capture":1
                        }).then((res)=>{
                            window.console.log(res)
                            this.razorpay_order_id = res.id
                            var rzp1 = new window.Razorpay({...options,order_id:res.order_id}); 
                            rzp1.open()
                            }).catch((err)=>{
                                window.console.log(err)
                            })
        },
        fetchDetail(){
            this.$store.dispatch('getModelsWithoutDealer',{"id":this.$route.params.id})
        }
    },
created(){
    this.fetchDetail()
    this.superset = this.$route.params.value
     
     window.scrollTo({
      top: 0,
      left: 0,
      behavior: "smooth",
    });
},
watch:{
    cartdata(){
    //    this.superdata = 
    //     this.cartdata.superset.filter(x=>{
    //     return x.id == this.superset

    //     })
    },
     rtoSameAsDelivery(){
            this.rtoSameAsDeliveryTrigger()
        }
},
computed:{
    // cartdata(){
    //     return this.$store.state.getModelsWithoutDealer
    // },
    totalPrice(){
        var addonsPrice = 0
        if(this.cartdata[0].addons.length > 0){
            for(var i in this.cartdata[0].addons){
                addonsPrice = addonsPrice + Number(this.cartdata[0].addons[i].price)
            }
        }
        return Number(this.cartdata[0].selectedItem.price) + Number(addonsPrice)
    },
    convenienceAmount(){
        return Math.round(0.03*this.totalPrice)
    },
    checkOutPrice(){
        return Number(this.totalPrice) + Number(this.convenienceAmount)
    },
    valid(){
        if(this.first_name && this.last_name && this.phone_number && this.email){
            return true
        }else{
            return false
        }
    },
    cartdata() {
      return JSON.parse(localStorage.getItem('cart'))
    },
}

}
</script>


<style scoped>
a{
    color:#4E44D8 !important
}
.button:disabled{
    opacity: 0.2 !important;
}
 @font-face {
  font-family: Gilroy;
  src: url(../assets/font/Gilroy-Light.otf);
 }
@font-face {
  font-family: Gilroyf;
  src: url(../assets/font/Gilroy-ExtraBold.otf);
}
.font2{
    font-size: 18px;
    font-weight: bold;
    font-family: Gilroyf;
    color: #484848;
  }
  p{
      margin:0;
      padding: 0;
  }
@media all and (max-width:600px){
 .ghj{
     text-align:center !important
 }
 .bnm{
     font-size:14px
 }
 .font3{
         font-size: 14px;
    color: black;
    font-weight: 500;
 }
 .cvb{
     padding-left: 0  !important;
 }
}
</style>